<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Persona Feedback</title>
  <link rel="icon" href="/assets/icon-32.png"/>
  <link rel="stylesheet" href="taskpane.css"/>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; }
    .app { padding: 12px; display:flex; flex-direction:column; gap:12px; }
    .toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .left, .right { display:flex; gap:8px; align-items:center; }
    .hidden { display:none !important; }
    .row { display:flex; gap:8px; align-items:center; margin:6px 0; }
    select, input[type="text"], input[type="password"] { width:100%; padding:6px 8px; }
    .btn { padding:6px 10px; border:1px solid #ddd; background:#f7f7f7; border-radius:6px; cursor:pointer; }
    .btn.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
    .btn.ghost { background:transparent; border-color:transparent; color:#2563eb; }
    .section { border:1px solid #eee; border-radius:8px; padding:10px; }
    .section h3 { margin:0 0 8px 0; font-size:14px; }
    #legend .swatch { display:flex; align-items:center; gap:8px; margin:4px 0; font-size:12px; }
    .dot { width:10px; height:10px; border-radius:999px; display:inline-block; border:1px solid #8884; }
    .badge { padding:2px 6px; border-radius:999px; background:#eee; font-size:11px; }
    .badge-done { background:#16a34a22; color:#166534; border:1px solid #16a34a55; }
    .badge-failed { background:#dc262622; color:#7f1d1d; border:1px solid #dc262655; }
    .progress { height:6px; background:#f3f4f6; border-radius:999px; overflow:hidden; }
    .progress > div { height:100%; width:0%; background:#2563eb; transition:width .2s ease; }
    .result-card { border:1px solid #eee; border-radius:8px; padding:10px; margin-top:8px; }
    #debugPanel { border:1px dashed #ddd; padding:8px; border-radius:8px; max-height:160px; overflow:auto; background:#fafafa; }
    /* toast */
    #toast { position:fixed; right:12px; bottom:12px; background:#111; color:#fff; padding:10px 12px; border-radius:8px; display:none; z-index:1000; }
    #toastClose { margin-left:6px; cursor:pointer; }
    /* confirm modal */
    #confirmOverlay { position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; z-index:1000; }
    #confirmBox { background:#fff; width:320px; border-radius:10px; padding:14px; }
    #confirmBox h3 { margin:0 0 8px 0; }
    .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    label { font-size:12px; min-width:120px; color:#374151; }
    .kv { display:flex; gap:8px; align-items:center; }
    .hr { height:1px; background:#eee; margin:6px 0; }
  </style>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <div class="left">
      <button id="btnBack" class="btn hidden">← Back</button>
    </div>
    <div class="right">
      <button id="toggleDebug" class="btn">Show Debug</button>
      <button id="btnSettings" class="btn">⚙ Settings</button>
    </div>
  </div>

  <!-- REVIEW VIEW -->
  <div id="view-review" class="section">
    <h3>Persona Feedback</h3>
    <div class="row">
      <label for="personaSet">Persona Set</label>
      <select id="personaSet"></select>
    </div>
    <div class="row">
      <div class="kv"><strong>Personas:</strong> <span id="personaList"></span></div>
    </div>

    <div class="two-col">
      <div class="section">
        <h3>Legend</h3>
        <div id="legend"></div>
      </div>
      <div class="section">
        <h3>Controls</h3>
        <div class="row" style="gap:6px; flex-wrap:wrap;">
          <button id="runBtn" class="btn primary">Run Review</button>
          <button id="retryBtn" class="btn">Retry Failed</button>
          <button id="exportBtn" class="btn">Export Report</button>
          <button id="clearBtn" class="btn">Clear PF Comments</button>
          <button id="clearAllBtn" class="btn">Clear ALL Comments</button>
        </div>
        <div class="row">
          <div class="progress" style="flex:1"><div id="progBar"></div></div>
        </div>
        <div id="personaStatus"></div>
      </div>
    </div>

    <div id="results"></div>
  </div>

  <!-- SETTINGS VIEW -->
  <div id="view-settings" class="section hidden">
    <h3>Settings</h3>

    <div class="section">
      <h3>Model</h3>
      <div class="row">
        <label for="provider">Provider</label>
        <select id="provider">
          <option value="openrouter">OpenRouter</option>
          <option value="ollama">Ollama (local)</option>
        </select>
      </div>
      <div id="openrouterKeyRow" class="row">
        <label for="openrouterKey">OpenRouter API Key</label>
        <input id="openrouterKey" type="password" placeholder="sk-or-..."/>
      </div>
      <div class="row">
        <label for="model">Model ID</label>
        <input id="model" type="text" placeholder="openrouter/auto"/>
      </div>
    </div>

    <div class="section">
      <h3>Persona Settings</h3>
      <div class="row">
        <label for="settingsPersonaSet">Persona Set</label>
        <select id="settingsPersonaSet"></select>
      </div>
      <div id="personaEditor"></div>
      <div class="row" style="justify-content:flex-end; gap:8px;">
        <button id="restoreDefaults" class="btn">Restore Default Set</button>
        <button id="saveSettings" class="btn primary">Save Settings</button>
      </div>
    </div>
  </div>

  <div id="debugPanel" class="hidden section">
    <div class="row" style="justify-content:space-between;">
      <strong>Debug</strong>
      <button id="clearDebug" class="btn ghost">Clear</button>
    </div>
    <div id="debugLog" style="font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast"> <span id="toastMsg"></span> <span id="toastClose">✕</span> </div>

<!-- Confirm Modal -->
<div id="confirmOverlay">
  <div id="confirmBox">
    <h3 id="confirmTitle">Confirm</h3>
    <div id="confirmMessage" style="margin:8px 0 14px 0;"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="confirmCancel" class="btn">Cancel</button>
      <button id="confirmOk" class="btn primary">OK</button>
    </div>
  </div>
</div>

<script src="taskpane.bundle.js"></script>
</body>
</html>
